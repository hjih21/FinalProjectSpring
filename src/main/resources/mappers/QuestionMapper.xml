<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="practical.llm.question.mapper.QuestionMapper">

    <resultMap id="QuestionMap" type="practical.llm.question.domain.Question">
        <id     property="questionId"       column="question_id"/>
        <result property="userId"           column="user_id"/>
        <result property="documentId"       column="document_id"/>
        <result property="questionText"     column="question_text"/>
        <result property="lang"             column="lang"/>
        <result property="genPromptText"    column="gen_prompt_text"/>
        <result property="genPromptParams"  column="gen_prompt_params"/>
        <result property="createdAt"        column="created_at"/>
    </resultMap>

    <!--
        대량 INSERT
        - 워커에서 전달된 질문 목록을 INSERT
        - question_text 컬럼은 JSON 문자열을 기대하므로 Service에서 미리 '텍스트' 형태로 직렬화하여 전달
    -->
    <insert id="insertBatch">
        INSERT INTO tb_question
        (user_id, document_id, question_text, lang, gen_prompt_text, gen_prompt_params)
        VALUES
        /* 각 아이템을 쉼표로 구분하여 다중 VALUES 구문으로 삽입 */
        <foreach collection="list" item="q" separator=",">
            (#{q.userId}, #{q.documentId}, #{q.questionText}, #{q.lang},
            #{q.genPromptText}, #{q.genPromptParams})
        </foreach>
    </insert>
    <!-- 문서 ID 기준 최신순 조회 -->
    <select id="findByDocumentId" resultMap="QuestionMap">
        SELECT * FROM tb_question
        WHERE document_id = #{documentId}
        ORDER BY question_id DESC
    </select>

    <!-- 사용자 ID 기준 최신순 조회 -->
    <select id="findByUserId" resultMap="QuestionMap">
        SELECT * FROM tb_question
        WHERE user_id = #{userId}
        ORDER BY question_id DESC
    </select>

</mapper>