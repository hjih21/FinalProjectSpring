<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="practical.llm.question.mapper.QuestionMapper">

    <resultMap id="QuestionMap" type="practical.llm.question.domain.Question">
        <id     property="questionId"       column="question_id"/>
        <result property="userId"           column="user_id"/>
        <result property="documentId"       column="document_id"/>
        <result property="questionText"     column="question_text"/>
        <result property="lang"             column="lang"/>
        <result property="genPromptText"    column="gen_prompt_text"/>
        <result property="genPromptParams"  column="gen_prompt_params"/>
        <result property="createdAt"        column="created_at"/>
    </resultMap>

    <!--
        단건 INSERT (문서당 1행)
        - question_text 컬럼에는 질문 JSON 배열(문자열) 저장
        - Service/Controller 에서 JSON 문자열로 직렬화하여 넘겨주세요.
    -->
    <insert id="insertOne" parameterType="practical.llm.question.domain.Question">
        INSERT INTO tb_question
        (user_id, document_id, question_text, lang, gen_prompt_text, gen_prompt_params)
        VALUES
        (#{userId}, #{documentId}, #{questionText}, #{lang}, #{genPromptText}, #{genPromptParams})
    </insert>

    <!-- userId + documentId 로 최근 1건 조회 (문서당 1행 구조) -->
    <select id="findOneByUserAndDocument" resultMap="QuestionMap">
        SELECT
            question_id, user_id, document_id, question_text, lang,
            gen_prompt_text, gen_prompt_params, created_at
        FROM tb_question
        WHERE user_id = #{userId}
          AND document_id = #{documentId}
        ORDER BY question_id DESC
            LIMIT 1
    </select>
    <!-- 문서 ID 기준 최신순 조회 -->
    <select id="findByDocumentId" resultMap="QuestionMap">
        SELECT * FROM tb_question
        WHERE document_id = #{documentId}
        ORDER BY question_id DESC
    </select>

    <!-- 사용자 ID 기준 최신순 조회 -->
    <select id="findByUserId" resultMap="QuestionMap">
        SELECT * FROM tb_question
        WHERE user_id = #{userId}
        ORDER BY question_id DESC
    </select>

</mapper>