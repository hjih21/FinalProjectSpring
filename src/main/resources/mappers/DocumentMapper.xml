<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="practical.llm.file.mapper.DocumentMapper">

    <!--
      DocumentMapper: tb_document 테이블에 대한 MyBatis 매퍼
      - insert: 해시(sha256) 중복 시 UPSERT로 동작
      - findById / findByUserId: 조회
      - updateStatus: 상태 업데이트
      - findLatestIdByUserId: 사용자의 가장 최근 문서 ID
    -->
    <!--
      INSERT (UPSERT 동작)
      - sha256 UNIQUE 제약을 활용하여 이미 존재하면 기존 행의 document_id를 유지하고 필드를 갱신
      - COALESCE(meta, '{}')로 meta NULL 방지
    -->
    <insert id="insert"
            parameterType="practical.llm.file.domain.DocumentFile"
            useGeneratedKeys="true"
            keyProperty="documentId"
            keyColumn="document_id">
        INSERT INTO tb_document (user_id, document_title, mime_type, storage_uri,
                                 size_bytes, sha256, `status`, meta)
        VALUES (#{userId}, #{documentTitle}, #{mimeType}, #{storageUri},
                #{sizeBytes}, #{sha256}, #{status}, COALESCE(#{meta}, '{}')) AS new
        ON DUPLICATE KEY
        UPDATE
            document_id = LAST_INSERT_ID(document_id),
            document_title = new.document_title,
            mime_type = new.mime_type,
            storage_uri = new.storage_uri,
            size_bytes = new.size_bytes,
            `status` = new.`status`,
            meta = COALESCE(new.meta, tb_document.meta)
    </insert>

    <!-- 문서 PK로 단건 조회 -->
    <select id="findById" resultType="practical.llm.file.domain.DocumentFile">
        SELECT * FROM tb_document WHERE document_id = #{documentId}
    </select>

    <!-- 사용자 ID 기준 내림차순 목록 조회 -->
    <select id="findByUserId" resultType="practical.llm.file.domain.DocumentFile">
        SELECT * FROM tb_document
        WHERE user_id = #{userId}
        ORDER BY document_id DESC
    </select>

    <!-- 상태 필드만 변경 -->
    <update id="updateStatus">
        UPDATE tb_document SET status = #{status}
        WHERE document_id = #{documentId}
    </update>



    <select id="findLatestIdByUserId" resultType="long">
        SELECT document_id
        FROM tb_document
        WHERE user_id = #{userId}
        ORDER BY created_at DESC, document_id DESC
            LIMIT 1
    </select>

</mapper>